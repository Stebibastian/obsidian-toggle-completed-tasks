/* Toggle Completed Tasks Plugin Styles */

/* IMPORTANT: Order matters!
   First define EXCEPTIONS (Tasks Queries), then general rules */

/* ===== EXCEPTIONS: Tasks Plugin Queries - show ALL tasks ===== */
body.hide-completed-tasks .plugin-tasks-query-result .task-list-item.is-checked,
body.hide-completed-tasks .plugin-tasks-query-result .task-list-item {
    display: list-item !important;
}

/* Live Preview - Tasks in code blocks (queries are not affected) */
body.hide-completed-tasks .markdown-source-view.mod-cm6 .HyperMD-codeblock .HyperMD-task-line[data-task="x"] {
    display: block !important;
}

/* ===== GENERAL RULES: Hide completed tasks ===== */
/* Only outside of Tasks Plugin Queries */
/* Other status symbols remain VISIBLE: [/] in progress, [-] cancelled, [>] forwarded, etc. */

/* Reading View - ONLY hide [x] completed tasks, NOT other status symbols, NOT in Queries */
body.hide-completed-tasks .markdown-reading-view .task-list-item.is-checked:not([data-task="/"]):not([data-task="-"]):not([data-task=">"]):not([data-task="<"]):not([data-task="?"]):not([data-task="!"]):not([data-task="*"]):not([data-task='"']):not([data-task="l"]):not([data-task="b"]):not([data-task="i"]):not([data-task="S"]):not([data-task="I"]):not([data-task="p"]):not([data-task="c"]):not([data-task="f"]):not([data-task="k"]):not([data-task="w"]):not([data-task="u"]):not([data-task="d"]) {
    display: none !important;
}

/* Override above rule for Tasks Plugin Queries (higher specificity) */
body.hide-completed-tasks .plugin-tasks-query-result .task-list-item.is-checked:not([data-task="/"]):not([data-task="-"]):not([data-task=">"]):not([data-task="<"]):not([data-task="?"]):not([data-task="!"]):not([data-task="*"]):not([data-task='"']):not([data-task="l"]):not([data-task="b"]):not([data-task="i"]):not([data-task="S"]):not([data-task="I"]):not([data-task="p"]):not([data-task="c"]):not([data-task="f"]):not([data-task="k"]):not([data-task="w"]):not([data-task="u"]):not([data-task="d"]) {
    display: list-item !important;
}

/* Fallback: If data-task doesn't work, only hide classic checkboxes */
body.hide-completed-tasks .markdown-reading-view .task-list-item.is-checked:not(.task-list-item[data-task]) {
    display: none !important;
}

/* Override this rule for Tasks Plugin Queries too */
body.hide-completed-tasks .plugin-tasks-query-result .task-list-item.is-checked:not(.task-list-item[data-task]) {
    display: list-item !important;
}

/* Live Preview - ONLY hide [x] */
body.hide-completed-tasks .markdown-source-view.mod-cm6 .HyperMD-task-line[data-task="x"] {
    display: none !important;
}

/* ===== RECENT COMPLETED MODE ===== */
/* Show only recently completed tasks (determined by JS based on âœ… date) */

/* In recent mode, hide tasks marked as hidden by JS */
body.show-recent-completed-tasks .markdown-reading-view .task-list-item.recent-completed-hidden {
    display: none !important;
}

/* In recent mode, show tasks marked as visible by JS */
body.show-recent-completed-tasks .markdown-reading-view .task-list-item.recent-completed-visible {
    display: list-item !important;
}

/* Tasks Plugin Queries - always show all in recent mode too */
body.show-recent-completed-tasks .plugin-tasks-query-result .task-list-item {
    display: list-item !important;
}

/* ===== MESSAGES ===== */

/* "All tasks completed" message - injected dynamically by main.js based on language */
/* This is for Reading View - the Live Preview version is handled in main.js */

/* Suppress the message in Plugin query results */
body.hide-completed-tasks .markdown-reading-view .plugin-tasks-query-result ul::after,
body.hide-completed-tasks .markdown-reading-view [class*="tasks-"] ul::after,
body.hide-completed-tasks .markdown-reading-view div[class*="block-language-tasks"] ul::after {
    content: none !important;
    display: none !important;
}

/* Completion Message Link Styling */
.toggle-tasks-completion-message {
    transition: opacity 0.2s ease;
}

.toggle-tasks-completion-message:hover {
    opacity: 0.7;
}

/* Add New Task Link Styling */
.toggle-tasks-add-task-link {
    transition: opacity 0.2s ease;
}

.toggle-tasks-add-task-link:hover {
    opacity: 0.7;
}

/* Edit Icon Styling */
.toggle-tasks-edit-icon {
    width: 1em;
    height: 1em;
    font-size: 0.9em;
    vertical-align: middle;
    margin-left: 0.5em;
    cursor: pointer;
    color: var(--text-accent);
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    text-decoration: none;
    opacity: 0.6;
    transition: opacity 0.2s ease;
    display: inline !important; /* Force display */
    position: relative;
    z-index: 10; /* Ensure it's above other elements */
}

.toggle-tasks-edit-icon:hover {
    opacity: 1;
}

/* Make edit icon visible on task hover */
.task-list-item .toggle-tasks-edit-icon {
    opacity: 0.4;
    display: inline !important; /* Force display */
}

.task-list-item:hover .toggle-tasks-edit-icon {
    opacity: 1;
}

/* Ribbon Icon Styling */
.toggle-completed-tasks-ribbon {
    cursor: pointer;
}

/* Fix for images in task items - prevent double rendering */
/* When an img tag is inside a task-list-item, Obsidian renders it twice */
/* Hide the second occurrence of the image */
.task-list-item img + img {
    display: none !important;
}

/* Alternative: Hide images that are direct children (not in paragraph) */
.task-list-item > img {
    display: none !important;
}

/* But keep the first image in the paragraph */
.task-list-item p img:first-of-type {
    display: inline-block !important;
    max-width: 70%;
}

/* Hide all subsequent images in the same task item paragraph */
.task-list-item p img:not(:first-of-type) {
    display: none !important;
}
